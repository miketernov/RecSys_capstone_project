<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offline Recipe Recommender</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <h1>üç≥ Offline Recipe Recommender</h1>

    <input id="ingredientsInput" placeholder="Enter ingredients‚Ä¶" />
    <button id="searchBtn">Find Recipes</button>

    <div id="loading">Loading model‚Ä¶ please wait</div>
    <div id="results"></div>
  </div>

  <!-- MAIN APP SCRIPT -->
  <script type="module">
    import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.1";

    const loadingDiv = document.getElementById("loading");

    let embedder;
    let ready = false;

    async function init() {
      loadingDiv.textContent = "Loading MiniLM model (10‚Äì20 sec)‚Ä¶";

      embedder = await pipeline(
        "feature-extraction",
        "Xenova/all-MiniLM-L6-v2"
      );

      ready = true;
      loadingDiv.textContent = "Model loaded ‚úî";
    }

    init();

    // cosine
    function cosine(a, b) {
      let dot = 0, na = 0, nb = 0;
      for (let i = 0; i < a.length; i++) {
        dot += a[i] * b[i];
        na += a[i] ** 2;
        nb += b[i] ** 2;
      }
      return dot / (Math.sqrt(na) * Math.sqrt(nb));
    }

    async function recommend() {
      if (!ready) {
        alert("Model still loading...");
        return;
      }

      const text = document.getElementById("ingredientsInput").value.trim();
      if (!text) return;

      loadingDiv.textContent = "Embedding your ingredients‚Ä¶";

      const out = await embedder(text);
      const userEmbedding = Array.from(out.data[0]);

      loadingDiv.textContent = "Downloading recipe embeddings‚Ä¶";

      const recipes = await fetch(
        "https://github.com/miketernov/RecSys_capstone_project/releases/download/v1/recipes_with_embeddings.json"
      ).then(r => r.json());

      loadingDiv.textContent = "Computing similarity‚Ä¶";

      recipes.forEach(r => {
        r.score = cosine(userEmbedding, r.embedding);
      });

      const top = recipes.sort((a, b) => b.score - a.score).slice(0, 3);

      document.getElementById("results").innerHTML = top.map(r => `
        <div class="recipe-card">
          <h3>${r.cuisine.toUpperCase()}</h3>
          <b>Score:</b> ${r.score.toFixed(4)}<br>
          <b>Ingredients:</b> ${r.ingredients.join(", ")}
        </div>
      `).join("");

      loadingDiv.textContent = "";
    }

    document.getElementById("searchBtn").onclick = recommend;
  </script>

</body>
</html>
